<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>My Appointment</title>
        <link rel="stylesheet" type="text/css" th:href="@{/css/common.css}"/>
        <link rel="stylesheet" type="text/css" th:href="@{/layui/css/layui.css}"/>
        <script th:src="@{/layui/layui.js}"></script>
        <script th:src="@{/js/fetch-wrapper.js}"></script>
    </head>
    <body>
    <div th:fragment="content">
        <div class="layui-form search">
            <div class="layui-form-item">
                <label class="layui-form-label">Patient</label>
                <div class="layui-input-block">
                    <select name="patientId" id="patient">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">Doctor</label>
                <div class="layui-input-block">
                    <select name="doctorId" id="doctor">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <button style="margin-left: 15px" type="button" lay-submit lay-filter="onSearch" class="layui-btn">
                <i class="layui-icon layui-icon-search"></i>
            </button>
        </div>
        <table class="ui-usertable" id="table" lay-filter="tableFilter"></table>
    </div>
    <script>
        const layer = layui.layer
        let param = {}
        layui.use(async function() {
            const table = layui.table
            const form = layui.form
            const { data: userData } = await getRequest('/user/list')
            const { data: doctorData } = await getRequest('/doctor/list')
            let patientIdHtml = ''
            let doctorIdHtml = ''
            for (const user of userData) {
                patientIdHtml += `<option value="${user.id}">${user.name}</option>`
            }
            for (const doctor of doctorData) {
                doctorIdHtml += `<option value="${doctor.id}">${doctor.name}</option>`
            }
            document.querySelector('#patient').insertAdjacentHTML('beforeend', patientIdHtml)
            document.querySelector('#doctor').insertAdjacentHTML('beforeend', doctorIdHtml)
            form.render('select')

            table.render({
                elem: '#table',
                url: '/appointment/page',
                method: 'get',
                where: param,
                height: 'full-85',
                limits: [10, 20, 30, 50],
                page: true,
                cols: [
                    [
                        { field: 'id', title: 'ID', align: 'center' },
                        { field: 'date', title: 'Date', align: 'center' },
                        {
                            field: 'patientId', title: 'Patient', align: 'center', templet: function (d) {
                                let ele = ''
                                for (const val of userData) {
                                    if (val.id == d.patientId) {
                                        ele = '<div>' + val.name + '</div>'
                                        break
                                    }
                                }
                                return ele
                            }
                        },
                        {
                            field: 'doctorId', title: 'Doctor', align: 'center', templet: function (d) {
                                let ele = ''
                                for (const val of doctorData) {
                                    if (val.id == d.doctorId) {
                                        ele = '<div>' + val.name + '</div>'
                                        break
                                    }
                                }
                                return ele
                            }
                        },
                        { field: 'symptoms', title: 'Symptoms', align: 'center' },
                        { field: 'prescriptions', title: 'Prescriptions', align: 'center' },
                    ]
                ],
                id: 'tableReload',
                response: {
                    statusCode: 200
                },
                parseData: function(res ){
                    return {
                        'code': res.status,
                        'msg': res.message,
                        'count': res.data.total,
                        'data': res.data.records
                    }
                }
            })
            form.on('submit(onSearch)', data => {
                param = data.field
                table.reload('tableReload', {
                    where: param
                })
                return false
            })
            table.on('tool(tableFilter)', async function (e) {
                const id = e.data.id
                if (e.event == 'edit') {
                    // 编辑
                    layer.open({
                        type: 2,
                        title: 'Edit appointment',
                        shadeClose: true,
                        shade: 0,
                        area: ['500px', '70%'],
                        content: '/appointment/dialog?id=' + id
                    })
                } else {
                    // 删除
                    const res = await deleteRequest('/appointment/' + id)
                    if (res.status == 200) {
                        layer.msg(res.message, {
                            icon: 1,
                            time: 2000
                        }, function () {
                            window.location.reload()
                        })
                    } else {
                        layer.msg(res.message)
                    }
                }
            })
        })

    </script>
    <style>
        .layui-form-item {
            margin: 0;
        }
    </style>
    </body>
</html>